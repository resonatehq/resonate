# Release workflow is the main workflow that coordinates various GitHub workflows involved in a release of Resonate.
name: Release Workflow

on:
  release:
    types:
      - published
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v11

      - name: Use Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v6

      - name: Build Resonate binary
        run: |
          # Build resonate binary
          nix build ".#resonate"

          # Copy into root
          cp ./result/bin/resonate resonate

      - name: Check version
        env:
          GITHUB_REF_VERSION: ${{ github.ref_name }}
        run: |
          # Extract resonate version
          RESONATE_VERSION=$(./resonate -v | awk '{print $3}')
          RESONATE_VERSION="v${RESONATE_VERSION}"

          # Compare versions
          if [ "$RESONATE_VERSION" != "$GITHUB_REF_VERSION" ]; then
            echo "Version mismatch: resonate version ($RESONATE_VERSION) does not match GitHub ref ($GITHUB_REF_VERSION)"
            exit 1
          else
            echo "Version match: resonate version ($RESONATE_VERSION) matches GitHub ref ($GITHUB_REF_VERSION)"
          fi

  publish-github-image:
    needs: [check-version]
    uses: ./.github/workflows/release_publish_github_image.yaml
    with:
      tag: ${{ github.ref_name }}

  publish-github-artifacts:
    needs: [check-version]
    uses: ./.github/workflows/release_publish_github_artifacts.yaml
    with:
      tag: ${{ github.ref_name }}

  verify-github-artifacts:
    needs: [publish-github-image, publish-github-artifacts]
    uses: ./.github/workflows/release_verify_artifacts.yaml
    with:
      tag: ${{ github.ref_name }}
